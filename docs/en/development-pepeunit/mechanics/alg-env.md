# Algorithm for generating env.json for a Unit

::::info
The algorithm is used in three scenarios:
1. Retrieving [env.json](/en/definitions#env-json) via `get_env`
1. Setting [env.json](/en/definitions#env-json) via `set_env`
1. Any update of a [Unit](/en/definitions#unit) program: manual or automatic
::::

## Algorithm

The algorithm is based on the priority of the following four representations of [env.json](/en/definitions#env-json); the lower the number, the higher the priority:

Priority | Representation | Description
-- | -- | --
1 | `Manual` | Manual input from a [User](/en/development-pepeunit/mechanics/roles.html#user) in the UI of the [Frontend](/en/deployment/dependencies/frontend) or via `set_env` over [REST](/en/definitions#rest) and [GQL](/en/definitions#gql)
2 | `Stored in DB` | [env.json](/en/definitions#env-json) stored in the [Pepeunit](/en/conception/overview) database
3 | `Generated` | [Standard variables](/en/developer/files/struct-env-example-json#стандартные-переменные-pepeunit) generated by the [Backend](/en/deployment/dependencies/backend)
4 | `Target` | Variables specified by the [Unit Developer](/en/development-pepeunit/mechanics/roles#unit-developer) in [env_example.json](/en/definitions#env-example-json)

At the end of the algorithm, all keys that are not present in the `Target` set are removed.

::::info
If [env.json](/en/definitions#env-json) is generated to be sent to a [Unit](/en/definitions#unit) or displayed to a [User](/en/development-pepeunit/mechanics/roles.html#user), an additional variable `PU_COMMIT_VERSION` is added. It is not stored in the database.
::::

## Algorithm examples

### First env generation

Algorithm steps:
1. `Target` — taken as is.
1. `Generated` — fully re-generated by the [Backend](/en/deployment/dependencies/backend) and overwrite keys obtained from the previous step.
1. `Stored in DB` — not present.
1. `Manual` — not present.
1. All keys not present in `Target` are removed.

::::info
As a result you get an [env.json](/en/definitions#env-json) where variables from the [Unit Developer](/en/development-pepeunit/mechanics/roles#unit-developer) are overwritten by variables generated by [Pepeunit](/en/conception/overview). This [env.json](/en/definitions#env-json) is already suitable for use in a [Unit](/en/definitions#unit).
::::

### Unit changes its version automatically with a change in the set of keys

Algorithm steps:
1. `Target` — taken as is.
1. `Generated` — fully re-generated by the [Backend](/en/deployment/dependencies/backend) and overwrite keys obtained from the previous step.
1. `Stored in DB` — taken from the database and overwrite all values with matching keys from the previous step.
1. `Manual` — not present.
1. All keys not present in `Target` are removed.

::::info
As a result you get an [env.json](/en/definitions#env-json) where variables from the new version of [env_example.json](/en/definitions#env-example-json) created by the [Unit Developer](/en/development-pepeunit/mechanics/roles#unit-developer) are added.
::::

### User modifies an existing env

Algorithm steps:
1. `Target` — taken as is.
1. `Generated` — fully re-generated by the [Backend](/en/deployment/dependencies/backend) and overwrite keys obtained from the previous step.
1. `Stored in DB` — taken from the database and overwrite all values with matching keys from the previous step.
1. `Manual` — all keys provided by a [User](/en/development-pepeunit/mechanics/roles.html#user) overwrite keys obtained from the previous step.
1. All keys not present in `Target` are removed.

::::info
As a result you get an [env.json](/en/definitions#env-json) where new [User](/en/development-pepeunit/mechanics/roles.html#user) values overwrite the previous ones for keys that the [User](/en/development-pepeunit/mechanics/roles.html#user) changed.
::::


