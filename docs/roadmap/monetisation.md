# Монетизация для держателей инстансов

## Главная проблема

Отслеживание нагрузки - есть топики без префикса /pepeunit, которые то же занимают полосу пропускания emqx. Если обьём данных в datapipe ещё можно узнать и посчитать для всех Unit пользователей, то вот отследить, сколько занято полосы пропускания, очень тяжело

EMQX допускает такое отслеживание только в платной версии, а к концепции проекта это не подходит

Видимо, потребуется создать ещё один go сервис

:::danger
Пока данная проблема не решена, следующие пункты по сути не имеют смысла
:::

## Основные тезисы

1. Включается отключается флагом
1. Монетизация на основе криптовалют и Telegram кошелька
1. Деньги идут держателю Инстанса, на котором включена монетизация, т.к. держать инстанс это задача не из простых
1. В будущем, возможно, будет функционал, при включении которого деньги будут идти в том числе и создателям Pepeunit на кошелёк, но траты с этого кошелька будут регламентироваными. Подразумевается, что этот функционал будет предоставлять по специальной лицензии, или вообще будет отдельным микросервисом
1. 100% покрытие модульными тестами для кода денег
1. 100% интеграционное покрытие для кода денег

## Механизм монетизации

Нужные данные:

1. Для каждого Unit вычисляется массив среднего числа сообщений: `[месяц, неделя, день, час]`
1. Для каждого Unit Вычисляется динамика памяти в DataPipe
1. Возможности системы в целом: сколько есть постоянной памяти, сколько есть ресурса cpu, ram и т.д.; также в формате `[месяц, неделя, день, час]`

Механизм вычисляет каждый час суммарную нагрузку от Unit и сравнивает с показателями загрузки системы. На основании чего он вычисляет статус Инстанса:
1. Зелёный - доступен для создания Unit 
1. Жёлтый - система находится на грани тротлинга, осталось, например, меньше 10% ресурсов
1. Красный - система находится в тротлинге, часть Unit принудительно отключена. В токены Unit добавляется возможность временной блокировки, как ошибка отдаётся тротлинг системы

Монетизация строится на статусе инстанса, она включется только если статус инстанса Жёлтый. Все Unit раскрашиваются, по своим статистикам:
1. Зелёный - потребление ресурсов ниже 50 процентиля, низкое потребление ресурсов, работает бесплатно - монетизация не требуется
1. Жёлтый - потребление ресурсов выше 50 процентиля но ниже 80 процентиля
1. Красный - потребление ресурсов выше 80 процентиля

Жёлтый и Красный статусы, тратят внутреннюю валюту, сумма списывается с внутреннего счёта каждый час. При исчерпании суммы Unit останавливается.

Баланс пользователя:
1. Бесплатные токены, начисляемые каждый первый день месяца в размере, установленном админом, не суммируются
1. Пополняемые токены через крипту, сначала расходуются бесплатные токены, в случае их недостатка, начинают списываться честно заработанные пользователем

Возможности админа:
1. Установка процентилей жёлтых, зелёных и красных Unit
1. Размер ежемесячного пособия пользователям
1. Кран для добавления всем или конкретным пользователм денег на счёт
1. Установление цены в жёлтом и красном процентиле - в разных регионах, для людей разные подьёмные цены, пинг всё таки важный параметр, поэтому региональность будет

## Параметры

Все параметры монетизации и статусы должны быть включены в базовые параметры об инстансе, чтобы люди могли выбирать

## Борд графана

Общедоступный борд монетизации на каждом инстансе, кто сколько тратит из пользователей

## Средние значения нагрузки по сообщениям для repo registry

Этот параметр должен быть добавлен в реестр, обязательно. Желательно вообще подсвечивать на инстансе, сколько будет обходиться тот или иной registry

## Зачем в целом нужна монетизация ?

Монетизация - это единственный честный к пользователям способ предоставить им доступ к ограниченным ресурсам инстансов. По сути, это общеизвестное правило, по которому будут отключаться Unit при перегрузках Инстансов.

При этом у пользователей будет возможность вернуть в работу свои Unit, так же по общеизвестным правилам. Деньги от монетизации получают Держатели инстансов, это позволит им иметь финансовую подушку для организации работы инстансов

Чем популярнее инстанс, тем тяжелее его поддерживать, и тем больше средств должно быть у того, кто его поддерживает
