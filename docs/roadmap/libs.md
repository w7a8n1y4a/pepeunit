# 0.10.0 Библиотека python для PyPi


## Инициализация
- передаётся путь до файлов env.json, schema.json, log.json
- параметрами включается нужный функционал
- передаётся общая функция-обработчик MQTT сообщений

Опционально:
- передаётся экземпляр mqtt клиента - baselib (micropytho), paho (python), paho (go)
- передаётся экземпляр rest клиента - baselib (micropython), httpx (python), default (go)

## Базовый функционал PepeunitClient:
1. Наличие атрибута settings, позволяющего получать из него значение переменных окружения
    - Все переменные можно получить в формате pepeunit_client_obj.settings.VAR_NAME
1. Наличие атрибута unit_uuid, property который динамически вычисляет unit_uuid из JWT токена .settings.PEPEUNIT_TOKEN, используя встроенную библиотеку base64 для декодирования центральной части токена, ключ `uuid` возвращает unit_uuid
1. Динамическое обновление settings, путём считывания env.json, всё что строится на основе settings также обновляется
1. Функция получения набора топиков для подписки из schema.json
1. Функция обновления программы устройства update_device_program(archive_path: str), по пути до уже скачанного архива с обязательной логикой распаковки tar.gz архивов
1. Функция генерации состояния устройства, схема как в old_client.py - get_system_state
1. Логер позволяющий сохранять данные в log.json, и если передан mqtt_client, то передавать по mqtt
1. Функция получения полного лога из log.json
1. Атрибут schema, обновляемый на основе schema.json, к атрибуту schema, обращение должно быть в следующих 4х форматах:
    - .schema.input_base_topic
    - .schema.output_base_topic
    - .schema.input_topic
    - .schema.output_topic
1. Каждый из 4х вспомогательных атрибутов, должен уметь возвращать список, по ключу, например:
    - .schema.output_topic["input/pepeunit"] - должен вернуть ["devunit.pepeunit.com/751ea411-8068-42df-9c65-987f122f670e/pepeunit", ...]
1. При обновлении schema, обновляются и все зависящие вещи

Работа с файлами:
1. Функция обновления env.json, по пути до нового файлаыы
1. Функция получения значений из env.json
1. Функция обновления schema.json, по пути до нового файла
1. Функция получения значений из schema.json
1. Функция обновления log.json, по пути до нового файла
1. Функция получения полного лога из log.json

## Доп. Функционал если передаётся mqtt клиент
1. Все конфиги клиента делаются на основе .settings
1. Автоматическая подписка на все топики из .schema.input_base_topic (по ситуации, если требуется)
1. Автоматическая подписка на все топики из .schema.input_topic (по ситуации, если требуется)
1. Если в .schema.output_base_topic:
    - state/pepeunit, то включить функцию отправки состояния приложения old_client.py - get_system_state по таймеру с интервалом STATE_SEND_INTERVAL из настроек, используя генератор из базового функционала
    - log/pepeunit, то включить отправку лога по mqtt
1. Если в schema.input_base_topic есть топики (обработчики работают только при наличии обоих клиентов - MQTT + REST):
    1. update/pepeunit - должен вызывать процедуру обновления, если указан rest_client
    1. env_update/pepeunit - обработчик должен вызывать процедуру скачивания и установки нового env.json, если указан rest_client
    1. schema_update/pepeunit - обработчик должен вызвать процедуру скачивания и установки новой schema.json, если указан rest_client
    1. log_sync/pepeunit - обработчик должен получить полный log.json и отправить его по mqtt в топик .schema.output_base_topic[log/pepeunit], может работать без REST CLient
1. Функция отправки сообщений в топик mqtt, сразу по заданному, например .schema.output_topic[output/pepeunit] и на все топики в этом списке уходит сообщение mqtt
1. Функция подписки на топики, например: .schema.output_topic[input/pepeunit] и сразу на все топики с списке произошла подписка

## Доп. Функционал если передаётся rest клиент
1. Все конфиги клиента делаются на основе .settings, как и пути до бека
1. download_update() - скачивание архива обновления через rest, пример есть в old_client.py, оставим только tar.gz, т.к. самый простой
1. download_env() - скачивание env.json
1. download_schema() - скачивание schema.json
1. set_state_storage(uuid, state) - загрузка в Pepeunit Unit Storage
1. get_state_storage(uuid) - получение из Pepeunit Unit Storage
1. Путь для Unit Storage API: domain/prefix/api_prefix/unit/{uuid}

## Доп. Функционал если передаются оба клиента (MQTT + REST)
1. perform_update() - полный цикл обновления: MQTT получает команду → REST скачивает → базовый класс обновляется


## Работа с ошибками

1. Никаких print, только logging для критически важных сообщений в консоли
1. Если не передан один из клиентов, при этом вызывается функция требующая его, например обновление программы, но при этом передан только mqtt клент, то при получении сообщения, должно произойти возбуждение ошибки, и запись в log.json, т.к. есть mqtt_client должна произойти ещё и отправка по mqtt. При этом программа должна продолжить работать.
1. Ошибки не должны вызывать прекращение работы клиента
1. Критические ошибки (приводящие к неизбежному прекращению работы программы - память, CPU и т.д.), должны записываться в log.json
1. Глобальный обработчик исключений для критических ошибок