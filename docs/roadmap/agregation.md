# Конвейеры данных

## Текущее состояние системы
1. Авторизация для подписки и публикации в топики идёт через python, это делается через rest, с хорошей производительностью
    - рест автоматически раскидывается на отдельные воркеры
    - у emqx брокера есть кеширование для авторизаций
2. Есть 2 вида топиков
    - example.com/+/+/+/pepeunit - системные, они забронированы и их поведение стандартизировано в pepeunit
        - Идёт сохранение стандартизированного состояния, обновляются состояния обновлений и тд.
        - Выполняется одним потоком Uvicorn
        - Для топика state сохранение идёт в Postgres
        - Для топика log сохранение идёт в Clickhouse и обновляется время в Postgres
    - example.com/+/pepeunit - принадлежащие Unit
        - Прямое сохранение всего что выдают Unit, в виде текста в Postgres
        - В бд сохраняется только 1 запрос за N секунд по умолчанию 30
3. Общий лимит на обьём информации передаваемой в payload топика берётся из настроек
4. Выполняется одним потоком Uvicorn. Практический потолок 4к запросов в секунду

## Проектное состояние
1. Авторизация топиков остаётся без изменений
1. example.com/+/+/+/pepeunit остаётся в python
    - Разрешаем сохранять не чаще чем лимит backend_state_send_interval - 1 сек. 
    - Попробовать добавить лимит на паттерн в emqx
1. example.com/+/pepeunit переходит в go приложение
    - Go приложение поддерживает одно клиентское соединение и подписано на все топики вида example.com/+/pepeunit
    - Обрабатывает запросы согласно настроенным конвейерам
    - Настройки обработки для каждого топика - синхронизируется с python бэкендом
1. Конвейеры данных имеют следующие этапы:
    - Время действия
    - Фильтрация
    - Преобразование
    - Одна из политик накопления
    - Буферизация
    - Сохранение
1. После работы go приложения в системе есть обогащённые данные
1. Конвейер должно быть можно сохранять в yml, чтобы создатели Unit могли оставлять их в репозиториях
1. На стороне python должна быть возможность получать эти обогащённые данные в зависимости от их типа и настроек конвейера
1. Должна быть возможность экспорта данных для конкретных топиков
1. Таблицы clickhose сделать отдельными для каждого рода политики, чтобы запросы были эффективнее

## Время действия 

1. от какой-то даты и в дальнейшем постоянными
2. от текущей даты до заданного значения
3. Диапазон времени по датам с часами и минутами
4. Постоянно

## Фильтрация
1. По типу входного значения
    - Числа
    - Текст
    - Изображения
    - Файлы
1. Белые списки значений
    - списки значений
1. Чёрные списки значений
    - списки значений - null, None, float('NaN'), float('inf')
1. Минимальный порог значений
    - одно число
1. Максимальный порог значений
    - два числа
1. Диапазон значений
    - два числа
1. Максимальная частота обновлений
    - N сек/минут/часов
1. Уникальность
    - проверка предидущего значения по хэшу payload
1. Размер
    - верхний порог размера в байтах/символах

## Преобразование
1. Числа
    - Округление
    - Домножение на коэффициент
    - Расчёт по формуле (Функционал после 1.0.0 через go expr, должен быть расчёт времени вычисления и проверка валидности выражения)
1. Изображение
    - Изменение размера
    - Изменение плотности пикселей
    - Обрезка
    - Конвертация формата изображения
1. Файлы
    - Сжатие Tgz (wbits + level), Tar, Zip

## Политики обработки
1. Хранение последнего значения
    - Числа - Postgres
    - Текст - Postgres
    - Изображения - Postgres + Minio
    - Файлы - Postgres + Minio
    - Например: последнее состояние - последнее состояние датчика
1. Хранение N последних записей
    - Числа - Clickhouse
    - Текст - Clickhouse
    - Изображения - Clickhouse + Minio
    - Файлы - Clickhouse + Minio
    - Например: ивентовые события - cработка сигнализации или датчика движения
1. Хранение временного окна
    - Числа - Clickhouse
    - Текст - Clickhouse
    - Изображения - Clickhouse + Minio
    - Файлы - Clickhouse + Minio
    - Например: когда нужно 100% разрешение по времени - узнать точную кривую муфельной печи для выведения коэффициентов
1. Агрегация
    - Числа - Clickhouse
    - Например: создание ровных временных редов с заданным разрешением - датчики температуры, влажности и давления
1. Видео из изображений
    - Изображения - Clickhouse + Minio
    - Например: таймлапсы через esp32 cam
       
### Видео из изображений
1. Размер окна: от 1 минуты до 12 часов, при этом периоды привязаны к 00:00
1. Установка частоты кадров
1. Установка кодека при создании видео из изображений

### Агрегация
1. Размер окна: от 1 минуты до 12 часов, при этом периоды привязаны к 00:00
1. Идёт буферизация за указанное время, до следующего времени после чего происходит вычисление с сохранением в clickhouse:
    - min/max
    - sum
    - avg

## Буферизация
1. Размер пачки данных
    - Хранение N последних записей
    - Хранение временного окн
1. Время накопления пачки данных от 1 минуты до N часов
    - Хранение N последних записей
    - Хранение временного окна

## Сохранение
- скрытый от пользователя этап

1. Расчитывает размер сохраняемых данных, и вписывает его clickhouse или postgres

## Лимитирование
- скрытый от пользователя этап

1. Для ёмких конвейеров, нужна система лимитирования

## Пример yml

```yml
version: 1.0  # Версия схемы конфигурации

pipeline:
  active_period:
    type: "date_range"  # permanent/from_date/to_date/date_range
    start: 2023-11-15T00:00:00Z
    end: 2024-11-15T00:00:00Z

  filters:
    type_input_value: "number" # number/text/image/binary
    type_value_filtering: "whitelist" # null/whitelist/blacklist
        values: [1,2,3,4,5]
    type_value_threshold: "range" # null/min/max/range
        min: -40
        max: 120
    max_rate: "10s" # Ns/Nm/Nh
    last_unique_check: false
    max_size: 10 # in symbols

  transformations:
    - type: "numeric"  # numeric/image/file
      multiplication: true
        coefficient: 0.3
      round: true
        decimal_point: 3
    - type: "image"  # numeric/image/file
      resize: true
        width: 640
        hight: 320
      pixel_density: true
        dpi: 300
      clipping: true
        x: 50
        y: 50
        width: 240
        hight: 120
      format: "jpg" # null/png/jpg/svg/webp
    - type: "file"  # numeric/image/file
      compression: tgz # null/tgz/tar/zip
        wbits: 0
        level: 15

  processing_policy:
    - type: "last_value"
    - type: "n_records"
      count_records: 1024  # 1-8192
    - type: "time_window"
      start: 2023-11-15T00:00:00Z
      end: 2024-11-15T00:00:00Z
    - type: "aggregation"
      window_size: "1h"  # 1m, 5m, 1h, 12h
      aggregation_functions: "avg" # avg/min/max/sum
    - type: "video"
      frame_rate_per_second: dynamic # dynamic/Nframe
      codec: H.264/AVC # из ffmpeg

  save_buffering:
    # stage only for n_records and time_window
    - max_items: 10 # 1-2048
    - accumulation_time: 5m # 1m-12h
```

## Ожидания

- Система может накапливать обогащённые данные
- Система может предоставлять эти данные пользователям
