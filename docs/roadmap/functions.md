# Дорожная карта для Pepeunit

## 0.4.0 Рефактор
1. Поправить нейминг у классов которые сосут данные с гитлаба и гитхаба
1. Разбить классы - сервисы на отдельные интерфейсы
1. Попробовать написать нормальные unit тесты в этих небольших классах
1. Добавить типы ошибок от Exception python. Сделать оболочку для прокидования текста
    - Т.е. вызываться будет raise определённого класса с передаваемым текстом
    - Это позволит в тестах, таргетно проверять ошибки
1. Решить проблему долгих интеграционных тестов - перенести unit клиенты в потоки и процессы
1. Перенести нагрузочные тесты в репозиторий бэкенда
1. Перевод нагруженных ручек на async

## Логирование и алертинг для Unit

1. Стандартный топик log/pepeunit
1. debug, info, warning, error, critical
1. Нужна стандартная переменная окружения в env.json, указывающая какой уровень логирования будет отправляться в log/pepeunit
1. Нужно установить начиная с какого уровня лога, будет отправляться alert
1. Нужно установить стандартное время жизни лога - по умолчанию 86400
1. Складывать логи в clickhouse
1. clickhouse должен позволять делать запросы на выборку всех логов конкретного устройства, например по названию топика логов
1. EMQX должен пересылать алерты на определённый тип ошибок, на основе Rule Engine
1. Дросселирование в телеграм должно работать через Backend, а значит нужна пременная, регламентирующая расстояние между алертами в телеге 

## Базовый функционал для Telegram
1. Написать интеграцию с телеграм - для охвата мобильных устройств

## Система агрегации данных

Дать Пользователю создавать временного слушателя mqtt топиков, в идеале внешний сервис на go, а на бек добавить обратную очередь на сохранение:
1. Он бы подписывался на все или часть топиков пользователя
    - на определённое время
    - c ограничением по объёму сохраняемой информации
1. Нужно несколько типов слушателей:
    - долговременные
    - агрегационные со смещающимся окном
    - подумать о возможности динамического размера окна
1. Стратегии сохранения
    - хранятся только данные уже рассчитанные
    - cохранение данных в телегу
    - clickhouse
1. Система собираемых бордов с данными для Graphana и TG интеграции

## Анализ динамического состояния узла

1. Анализ общего числа сообщений поступающих на бэкенд
    - mqtt
    - gql
    - rest
    - aiogram
1. Трекер занятых ресурсов - cpu, ram
1. Оставшееся место
1. Аптайм
1. Трекер ошибок, какие возникают чаще, а какие реже
1. Трекер алерт крашей, с дросселированием - в телегу админу, надо запоминать сколько раз возник

## Анализ нагрузки

На эти метрики будет опираться монетизация и настройки пользователей

1. Система отслеживания нагрузки на топики Unit - Расчёт желательно на стороне EMQX
1. Система отслеживания средней нагрузки на один Unit - Метрика загрузки для repo
1. Метрикой должен быть MPS - запросы в секунду
1. Нужна автоматическая отсечка, если Unit превысил лимиты

## Монетизация для держателей инстансов

1. Подключаемая монетизация на основе Telegram и криптовалют
1. Основана должна быть на нагрузке от Unit, который создаёт юзер
1. Возможность настройки монетизации для администратора
1. Агригируещие топики должны быть монетизированы с другой политикой, т.к. они несут накладные расходы на хранение данных

## Система грейдов инстансов

1. Добавить итеративность в проверку нагрузки
1. Добавить хэш в отчёт, чтобы было сложнее его поменять
1. Отчёт по нагрузке должен предоставляться по спец запросу load_limit
1. Число бесплатных MPS
1. Стоймость MPS всверх бесплатных
1. Число бесплатных топиков с агрегацией (нужно придумать метрику)
1. Стоймость за один топик с агрегацией (нужно придумать метрику)
1. Токен доступа для скрапера генерит Админ инстанса

## Федерация

TODO: требуется крепкая проработка

1. Федеративный хаб Repo, c поиском по Unit на мультиинстансе
1. Внедрение activity pub
1. Система взаимодействия между инстансами
1. Проработать activity pub
1. Проработать bridge y emqx, до разных инстансов
1. Белые и чёрные листы доменов для создания repo
1. Импорт экспорт всех данных учётной записи по запросу Пользователя
1. Добавить кнопку обновления env от pepeunit, для будущей возможности переноса Unit на другие инстансы
1. Проработать условия автоматического бана внешних инстансов
1. Нужен бан топиков от внешних инстансов, по условиям (выдумать условия)

## Видео для документации
1. Нужно видео по развёртыванию Pepeunit
1. Нужно видео где с 0 на уже развёрнутом инстансе, создаётся готовая система по существующим Repo - от лица Пользователя
1. Нужно видео где с 0 на уже развёрнутом инстансе, разработчик Unit последовательно создёт новый Unit с 0 - от лица разработчика Unit