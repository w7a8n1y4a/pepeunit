# Дорожная карта для Pepeunit

## Реализация перехода между версиями и бэкапов

1. Придумать флаги обновлений для генератора .env.services файлов
1. Создание бэкапов перед обновлением
1. Создание бэкапов по команде

## Улучшения бэкенда до многопоточности

1. Сделать через функцию хэширования по наименованию топиков распределение на N потоков
1. Подписка на mqtt должна быть только в распределяющем потоке
1. Пуллинг только в 1 из потоков
1. Настройки брокера только в 1 из потоков
1. Изменить структуру кэша, на локальный внутри потоков, с временем жизни отдельных элементов

## Система грейдов инстансов

1. Сделать утилиту нагрузки, в разных сценариях rest, gql, mqtt - консольную, с выдачей отчёта
1. Отчёт должен предоставляться по спец запросу load_limit
1. Число бесплатные MPS
1. Стоймость MPS всверх бесплатных
1. Число бесплатных топиков с агрегацией (нужно придумать метрику)
1. Стоймость за один топик с агрегацией (нужно придумать метрику)
1. Токен доступа для скрапера генерит Админ инстанса

## Дросселирование MQTT сообщений через настройки EMQX

1. Для domain.com/+/+/+/pepeunit 1 сообщение в секунду
1. Для domain.com/+/pepeunit - 1 сообщение в секунду
1. Для остальных паттернов - 10 сообщений в секунду

## Логирование и алертинг для Unit

1. Стандартный топик log/pepeunit
1. debug, info, warning, error, critical
1. Нужна стандартная переменная окружения в env.json, указывающая какой уровень логирования будет отправляться в log/pepeunit
1. Нужно установить начиная с какого уровня лога, будет отправляться alert
1. Нужно установить стандартное время жизни лога - по умолчанию 86400
1. Складывать логи в clickhouse
1. clickhouse должен позволять делать запросы на выборку всех логов конкретного устройства, например по названию топика логов
1. EMQX должен пересылать алерты на определённый тип ошибок, на основе Rule Engine
1. Дросселирование в телеграм должно работать через Backend, а значит нужна пременная, регламентирующая расстояние между алертами в телеге 

## Базовый функционал для Telegram
1. Написать интеграцию с телеграм - для охвата мобильных устройств

## Анализ динамического состояния узла

1. Анализ общего числа сообщений поступающих на бэкенд
    - mqtt
    - gql
    - rest
    - aiogram
1. Трекер занятых ресурсов - cpu, ram
1. Трекер ошибок, какие возникают чаще, а какие реже
1. Трекер алерт крашей, с дросселированием - в телегу админу, надо запоминать сколько раз возник

## Анализ нагрузки

На эти метрики будет опираться монетизация и настройки пользователей

1. Система отслеживания нагрузки на топики Unit - Расчёт желательно на стороне EMQX
1. Система отслеживания средней нагрузки на один Unit - Метрика загрузки для repo
1. Метрикой должен быть MPS - запросы в секунду

## Система агрегации данных

1. Аггрегация со смещающимся окном, хранятся только данные уже рассчитанные
1. Подумать о возможности динамического размера окна
1. Поидее подойдёт clickhouse
1. Такие топики должны быть монетизированы с другой политикой, т.к. они несут накладные расходы на хранение данных
1. Система собираемых бордов с данными для Graphana и TG интеграции

## Монетизация для держателей инстансов

1. Подключаемая монетизация на основе Telegram и криптовалют
1. Основана должна быть на нагрузке от Unit, который создаёт юзер
1. Возможность настройки монетизации для администратора

## Федерация

TODO: требуется крепкая проработка

1. Федеративный хаб Repo, c поиском по Unit на мультиинстансе
1. Внедрение activity pub
1. Система взаимодействия между инстансами
1. Проработать activity pub
1. Проработать bridge y emqx, до разных инстансов
1. Белые и чёрные листы доменов для создания repo
1. Импорт экспорт всех данных учётной записи по запросу Пользователя
1. Добавить кнопку обновления env от pepeunit, для будущей возможности переноса Unit на другие инстансы

## Видео для документации
1. Нужно видео по развёртыванию Pepeunit
1. Нужно видео где с 0 на уже развёрнутом инстансе, создаётся готовая система по существующим Repo - от лица Пользователя
1. Нужно видео где с 0 на уже развёрнутом инстансе, разработчик Unit последовательно создёт новый Unit с 0 - от лица разработчика Unit